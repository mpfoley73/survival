[
  {
    "objectID": "02-km.html",
    "href": "02-km.html",
    "title": "2  Kaplan-Meier",
    "section": "",
    "text": "2.1 Assumptions\nSurvival data are generally described and modeled in terms of the survivor function and the hazard function. The survivor function \\(S(t)\\) is the probability of surviving to some time beyond t and is usually estimated by the Kaplan-Meier (KM) method. The log-rank test is then used to test for differences between survival curves for treatment groups. The hazard function \\(h(t)\\) is the instantaneous event rate at t given survival up to t. It is primarily used as a diagnostic tool. KM analyses are limited, however, because they cannot adjust for subject-related confounding variables. Adjust for covariates with multivariate survival analyses such as the parametric and semi-parametric models (Clark 2003).\nThe KM estimator for the survival function is the product over failure times of the conditional probabilities of surviving to the next failure time.\n\\[\\hat{S}(t) = \\prod_{i: t_i &lt; t}{\\frac{n_i - d_i}{n_i}} \\tag{2.1}\\]\nwhere \\(n_i\\) is the number of subjects at risk at time \\(i\\) and \\(d_i\\) is the number incurring the event. I.e., \\(\\hat{S}(t)\\) is the sum-product of the survival proportions at each time interval, the cumulative survival probability. The KM curve falls only when an event occurs, not when a subject is censored. Confidence limits are calculated using the “delta” method to obtain the variance of \\(\\log \\hat{S}(t)\\).1\nThe KM method is demonstrated here with a case study using the survival::lung data set.\nThe study investigated differences in all-cause mortality between men and women diagnosed with advanced lung cancer. 227 participants aged 39 to 82 were monitored up to three years until time of death. The participants were segmented into three groups according to their ECOG performance score: Asymptomatic, symptomatic but completely Ambulatory, and Bedridden at least part of the day. Participants’ age and gender were captured as possible controlling covariates, but will not be used here since KM analyses only compare the distributions among levels of a single factor. Table 2.1 presents the summary statistics.\nYou can run a KM analysis for processes that have a binary outcome (e.g., dead vs alive), a precise event time (number rather than an interval), minimal left censoring (unknown starting times), and independent censoring (independent of the event).2\nTwo assumptions underlie the KM procedure:\nCohort effects should not apply in a study lasting less than 3 years, so that assumption is not tested in this case study.\nThe participant censoring plot shows censored cases were equally spread over time and not too dissimilar for the Asymptomatic and Ambulatory groups, but the Bedridden group had a low number of censoring events (Figure 2.1). Censored cases were negatively associated with symptom severity, Asymptomatic, 26 (41%), Ambulatory, 31 (27%), and Bedridden, 6 (12%) study groups.3\nShow the code\nd_lung |&gt;\n  filter(status == \"censored\") |&gt;\n  ggplot(aes(x = time, y = fct_rev(ph.ecog))) +\n  geom_point() +\n  theme_light() +\n  labs(title = \"Participant Censoring\", x = \"Time (days)\", y = NULL)\n\n\n\n\n\nFigure 2.1: Censored cases were equally spread over time",
    "crumbs": [
      "<span class='chapter-number'>2</span>  <span class='chapter-title'>Kaplan-Meier</span>"
    ]
  },
  {
    "objectID": "02-km.html#assumptions",
    "href": "02-km.html#assumptions",
    "title": "2  Kaplan-Meier",
    "section": "",
    "text": "No Cohort Effects. There are no secular trends. E.g., staggered starting times may encompass the introduction of new therapies which affect survival. Test for cohort effects by running KM tests for multiple time intervals. You only need to test for this if there is reason to believe effects may be present.\nSimilar Censorship Patterns. The amount and pattern of censoring should be similar. Censorship patterns can be tested by inspection.",
    "crumbs": [
      "<span class='chapter-number'>2</span>  <span class='chapter-title'>Kaplan-Meier</span>"
    ]
  },
  {
    "objectID": "02-km.html#fitting-the-model",
    "href": "02-km.html#fitting-the-model",
    "title": "2  Kaplan-Meier",
    "section": "2.2 Fitting the Model",
    "text": "2.2 Fitting the Model\nCalculate \\(\\hat{S}(t)\\) with survival::survfit(). survfit() operates on a Surv object, created by survival::Surv(). Explanatory variables can be defined as factors, but the event indicator, status, must be numeric or boolean, coded as 0|1, 1|2, or FALSE|TRUE.4 survfit() creates survival curves from a formula or from a previously fitted Cox model. If the confidence interval crosses zero, specify the log-log transformation parameter conf.type = \"log-log\" (this one doesn’t need it).\n\n(km_fit &lt;- survfit(Surv(time, status == \"died\") ~ ph.ecog, data = d_lung))\n\nCall: survfit(formula = Surv(time, status == \"died\") ~ ph.ecog, data = d_lung)\n\n                       n events median 0.95LCL 0.95UCL\nph.ecog=Asymptomatic  63     37    394     348     574\nph.ecog=Ambulatory   113     82    306     268     429\nph.ecog=Bedridden     51     45    183     153     288\n\n\n37 of the 63 Asymptomatic subjects died, 82 of the 113 Ambulatory subjects died, and 45 of the 51 Bedridden subjects died. gtsummary::tbl_survfit() presents a similar summary in a formatted table. Table 2.2 additionally presents the effects of sex and age.\n\n(km_gt &lt;- gtsummary::tbl_survfit(\n  list(\n    survfit(Surv(time, status == \"died\") ~ 1, data = d_lung),\n    survfit(Surv(time, status == \"died\") ~ ph.ecog, data = d_lung),\n    survfit(Surv(time, status == \"died\") ~ sex, data = d_lung),\n    survfit(Surv(time, status == \"died\") ~ age_bin, data = d_lung)\n  ),\n  probs = 0.5,\n  label_header = \"**Median Survival**\"\n))\n\n\n\nTable 2.2: Kaplan-Meier model fit.\n\n\n\n\n\n\n\n\n\n\n\n\n\nCharacteristic\nMedian Survival\n\n\n\n\nOverall\n310 (285, 363)\n\n\nph.ecog\n\n\n\n\n    Asymptomatic\n394 (348, 574)\n\n\n    Ambulatory\n306 (268, 429)\n\n\n    Bedridden\n183 (153, 288)\n\n\nsex\n\n\n\n\n    Male\n270 (218, 320)\n\n\n    Female\n426 (348, 550)\n\n\nage_bin\n\n\n\n\n    38,55]\n320 (226, 533)\n\n\n    55,65]\n348 (285, 477)\n\n\n    65,83]\n301 (267, 361)\n\n\n\n\n\n\n\n\n\n\n\nValues are median with 95% CI. Asymptomatic participants had a median survival time of 394 (348, 574) days. This was longer than the Ambulatory group, 306 (268, 429) days, and Bedridden group, 183 (153, 288) days. Lower levels of ECOG appear to have a protective effect, but whether it is statistically significant requires a formal statistical test.\nExtract values for reporting with gtsummary::inline_text() (as was done above), or create a summary object. The table attribute of the summary object is a named numeric matrix. E.g., get Asymptomatic events with km_smry$table[\"ph.ecog=Asymptomatic\", \"events\"].\n\nkm_smry &lt;- summary(km_fit)\n\n# Example: Asymptomatic median survival time.\nkm_smry$table[\"ph.ecog=Asymptomatic\", \"median\"]\n## [1] 394\n\nYou can also use summary() with the time parameter to estimate survival up until a point in time.\n\nsummary(km_fit, time = 500)\n\nCall: survfit(formula = Surv(time, status == \"died\") ~ ph.ecog, data = d_lung)\n\n                ph.ecog=Asymptomatic \n        time       n.risk      n.event     survival      std.err lower 95% CI \n    500.0000      13.0000      30.0000       0.3745       0.0751       0.2528 \nupper 95% CI \n      0.5548 \n\n                ph.ecog=Ambulatory \n        time       n.risk      n.event     survival      std.err lower 95% CI \n    500.0000      21.0000      67.0000       0.3054       0.0505       0.2209 \nupper 95% CI \n      0.4223 \n\n                ph.ecog=Bedridden \n        time       n.risk      n.event     survival      std.err lower 95% CI \n    500.0000       7.0000      40.0000       0.1635       0.0552       0.0844 \nupper 95% CI \n      0.3169 \n\n\ngtsummary::tbl_survfit() does something similar.\n\ngtsummary::tbl_survfit(km_fit, times = 500)\n\n\n\n\n\n\n\n\n\n\n\nCharacteristic\nTime 500\n\n\n\n\nph.ecog\n\n\n\n\n    Asymptomatic\n37% (25%, 55%)\n\n\n    Ambulatory\n31% (22%, 42%)\n\n\n    Bedridden\n16% (8.4%, 32%)\n\n\n\n\n\n\n\nbroom::tidy() summarizes the data by each event time. At time t = 5, 1 of the 63 Asymptomatic ECOG at risk died, so \\(S(5) = 1 - \\frac{1}{63} = .9841\\). At t = 11, 1 of the 62 that remained died, so \\(S(11) = S(5) \\cdot \\frac{1}{62} = .9841 \\cdot .9839 = .9683\\), and so on. This is the support for the survival curves.\n\nbroom::tidy(km_fit)\n\n# A tibble: 216 × 9\n    time n.risk n.event n.censor estimate std.error conf.high conf.low strata   \n   &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt; &lt;chr&gt;    \n 1     5     63       1        0    0.984    0.0160     1        0.954 ph.ecog=…\n 2    11     62       1        0    0.968    0.0228     1        0.926 ph.ecog=…\n 3    15     61       1        0    0.952    0.0282     1        0.901 ph.ecog=…\n 4    31     60       1        0    0.937    0.0328     0.999    0.878 ph.ecog=…\n 5    53     59       1        0    0.921    0.0370     0.990    0.856 ph.ecog=…\n 6    65     58       1        0    0.905    0.0409     0.980    0.835 ph.ecog=…\n 7    81     57       1        0    0.889    0.0445     0.970    0.815 ph.ecog=…\n 8   147     56       1        0    0.873    0.0480     0.959    0.795 ph.ecog=…\n 9   166     55       1        0    0.857    0.0514     0.948    0.775 ph.ecog=…\n10   175     54       0        1    0.857    0.0514     0.948    0.775 ph.ecog=…\n# ℹ 206 more rows\n\n\nThe KM plot in Figure 2.2 gives you a better feel for the data. Vertical drops indicate events and vertical ticks indicate censoring. Cumulative survival is negatively associated with the ECOG performance score. There is no substantial crossing of the survival curves that would affect the power of the statistical tests. The curves are similarly shaped. The log-rank test is ideal for similarly shaped distributions and distributions that do not cross. The Breslow, and Tarone-Ware tests are more sensitive alternatives.\n\n\n\n\n\n\nNote\n\n\n\nsurvminer does a good job plotting KM models and includes a risk table. But you can do just as good of a job with ggplot and control more of the output. Figure 2.3 combines ggplot with giraph for a full risk table in the tooltips.\n\n\n\nsurvminerggplot\n\n\n\n\nShow the code\nggsurvplot(\n  km_fit,\n  data = d_lung,\n  fun = \"pct\",\n  risk.table = TRUE,\n  fontsize = 3, # used in risk table\n  surv.median.line = \"hv\", # median horizontal and vertical ref lines\n  ggtheme = theme_light(),\n  palette = c(\"goldenrod\", \"sienna\", \"tomato\"),\n  title = \"Kaplan-Meier Survival Function Estimate\",\n  legend.title = \"ECOG\",\n  legend.labs = levels(d_lung$ph.ecog)\n)\n\n\n\n\n\nFigure 2.2: Kaplan-Meier survival curve.\n\n\n\n\n\n\n\n\n\n\n\n\nShow the code\nmed &lt;-\n  broom::tidy(km_fit) |&gt;\n  filter(estimate &lt; .5) |&gt;\n  slice_max(estimate, by = strata) |&gt;\n  mutate(strata = str_remove(strata, \"ph.ecog=\"))\np &lt;-\n  broom::tidy(km_fit) |&gt;\n  mutate(\n    strata = str_remove(strata, \"ph.ecog=\"),\n    tt = glue(\"{strata}\\n\\nTime: {time}\\nAt risk: {n.risk}\\nEst.: \",\n              \"{percent(estimate, .1)}\")\n  ) |&gt;\n  ggplot(aes(x = time, y = estimate, color = strata)) +\n  geom_step() +\n  geom_segment(\n    data = med, \n    aes(x = 0, xend = time, y = .5, yend = .5),\n    linetype = 2\n  ) +\n  geom_segment(\n    data = med, \n    aes(x = time, xend = time, y = 0, yend = .5),\n    linetype = 2\n  ) +\n  geom_point_interactive(aes(tooltip = tt)) +\n  theme(legend.position = \"top\") +\n  scale_color_manual(values = c(\"goldenrod\", \"sienna\", \"tomato\")) +\n  scale_y_continuous(labels = percent_format(1)) +\n  labs(\n    x = \"time (days)\", y = \"Survival probability\", color = NULL,\n    title = \"Kaplan-Meier Survival Function Estimate\"\n  )\ngirafe(ggobj = p)\n\n\n\n\nFigure 2.3: Kaplan-Meier survival curve using ggplot.\n\n\n\n\n\n\n\n\n\n\n\nggsurvplot() can also plot the cumulative risk function, \\(F(t) = 1 - S(t)\\), with parameter fun = \"event\" (Figure 2.4), and the cumulative hazard function, \\(H(t) = -\\log S(t)\\), with parameter fun = \"cumhaz\" (Figure 2.5).\n\n\n\n\n\nShow the code\nggsurvplot(\n  km_fit,\n  data = d_lung,\n  fun = \"event\",\n  linetype = \"strata\", # Change line type by groups\n  pval = FALSE,\n  conf.int = FALSE,\n  ggtheme = theme_bw(),\n  palette = c(\"goldenrod\", \"sienna\", \"tomato\"),\n  title = \"Cumulative Risk\"\n)\n\n\n\n\n\nFigure 2.4: Kaplan-Meier cumulative risk curve.\n\n\n\n\n\n\n\n\n\n\n\n\nShow the code\nggsurvplot(\n  km_fit,\n  data = d_lung,\n  fun = \"cumhaz\",\n  linetype = \"strata\", # Change line type by groups\n  pval = FALSE,\n  conf.int = FALSE,\n  ggtheme = theme_bw(),\n  palette = c(\"goldenrod\", \"sienna\", \"tomato\"),\n  title = \"Cumulative Hazard\"\n)\n\n\n\n\n\nFigure 2.5: Kaplan-Meier cumulative hazard curve.",
    "crumbs": [
      "<span class='chapter-number'>2</span>  <span class='chapter-title'>Kaplan-Meier</span>"
    ]
  },
  {
    "objectID": "02-km.html#interpreting-results",
    "href": "02-km.html#interpreting-results",
    "title": "2  Kaplan-Meier",
    "section": "2.3 Interpreting Results",
    "text": "2.3 Interpreting Results\nDetermine whether there are significant differences in the fitted survival distributions using a log-rank test (and/or Breslow and Tarone-Ware test). If there are differences, run a pairwise comparison post-hoc test to determine which curves differ.\nThe log-rank test weights the difference at each time point equally. Compared to Breslow and Tarone-Ware, it places greater emphasis on differences at later rather than earlier time points. The Breslow test (aka generalized Wilcoxon or Gehan) weights the differences by the number at risk at each time point. The effect is to place greater weight on the differences at earlier time points. The Tarone-Ware test weights differences the same way as Breslow, but takes the square root of the number at risk.\n\n(km_diff &lt;- survdiff(Surv(time, status == \"died\") ~ ph.ecog, data = d_lung))\n\nCall:\nsurvdiff(formula = Surv(time, status == \"died\") ~ ph.ecog, data = d_lung)\n\n                       N Observed Expected (O-E)^2/E (O-E)^2/V\nph.ecog=Asymptomatic  63       37     54.2    5.4331    8.2119\nph.ecog=Ambulatory   113       82     83.5    0.0279    0.0573\nph.ecog=Bedridden     51       45     26.3   13.2582   15.9641\n\n Chisq= 19  on 2 degrees of freedom, p= 8e-05 \n\n\nThe survival distributions for the three interventions were statistically significantly different, \\(\\chi^2\\)(2) = 19.0, p &lt; .001.\nBreslow and Tarone-Ware are in the coin package.\n\ncoin::logrank_test(Surv(time, status == \"died\") ~ ph.ecog, data = d_lung, type = \"Tarone-Ware\")\n\n\n    Asymptotic K-Sample Tarone-Ware Test\n\ndata:  Surv(time, status == \"died\") by\n     ph.ecog (Asymptomatic, Ambulatory, Bedridden)\nchi-squared = 19.009, df = 2, p-value = 7.451e-05\n\ncoin::logrank_test(Surv(time, status == \"died\") ~ ph.ecog, data = d_lung, type = \"Gehan-Breslow\")\n\n\n    Asymptotic K-Sample Gehan-Breslow Test\n\ndata:  Surv(time, status == \"died\") by\n     ph.ecog (Asymptomatic, Ambulatory, Bedridden)\nchi-squared = 19.431, df = 2, p-value = 6.034e-05\n\n\nThree tests produced identical conclusions. The log rank test is an omnibus test. Create a pairwise comparisons table to see which groups differed.\n\n(km_pairwise &lt;- survminer::pairwise_survdiff(Surv(time, status == \"died\") ~ ph.ecog, data = d_lung))\n\n\n    Pairwise comparisons using Log-Rank test \n\ndata:  d_lung and ph.ecog \n\n           Asymptomatic Ambulatory\nAmbulatory 0.0630       -         \nBedridden  9e-05        0.0039    \n\nP value adjustment method: BH \n\n\nAdjust the statistical significance to compensate for making multiple comparisons with a Bonferroni correction. There are three comparisons so divide .05 by 3, so the significance threshold is p &lt; .0167. There was a statistically significant difference in survival distributions for Asymptomatic vs Bedridden, p &lt; .001, and Ambulatory vs Bedridden, p = 0.004, but not for Asymptomatic vs Ambulatory, p = 0.063.",
    "crumbs": [
      "<span class='chapter-number'>2</span>  <span class='chapter-title'>Kaplan-Meier</span>"
    ]
  },
  {
    "objectID": "02-km.html#reporting",
    "href": "02-km.html#reporting",
    "title": "2  Kaplan-Meier",
    "section": "2.4 Reporting",
    "text": "2.4 Reporting\nThe guidelines for reporting the Kaplan-Meier test are from Laerd’s Kaplan-Meier using SPSS Statistics (Laerd 2015). Report the results like this.\n\n227 Men and women diagnosed with advanced lung cancer aged 39 to 82 were monitored up to three years until time of death. Participants were classified into three groups according to their ECOG performance score: asymptomatic (n = 63), symptomatic but completely ambulatory (n = 113), and bedridden at least part of the day (n = 51). A Kaplan-Meier survival analysis (Kaplan & Meier, 1958) was conducted to compare survival times among the three ECOG performance scores. Censored cases were negatively associated with symptom severity, asymptomatic, 26 (41%), symptomatic but completely ambulatory, 31 (27%), and bedridden, 6 (12%) study groups. Participants that were asymptomatic had a median survival time of 394 (348, 574) days. This was longer than the ambulatory group, 306 (268, 429) days, and bedridden group, 183 (153, 288) days. A log rank test was run to determine if there were differences in the survival distribution for the different types of intervention. The survival distributions for the three interventions were statistically significantly different, \\(\\chi^2\\)(2) = 19.0, p &lt; .001. Pairwise log rank comparisons were conducted to determine which intervention groups had different survival distributions. A Bonferroni correction was made with statistical significance accepted at the p &lt; .017 level. There was a statistically significant difference in survival distributions for the aymptomatic vs bedridden, p &lt; .001, and ambulatory vs bedridden, p = 0.004, groups. However, the survival distributions for the asymptomatic vs ambulatory group were not statistically significant, p = 0.063\n\n\n\n\n\n\n\nClark, Bradburn, T. G. 2003. “Survival Analysis Part i: Basic Concepts and First Analyses.” British Journal of Cancer 89 (2). https://doi.org/10.1038/sj.bjc.6601118.\n\n\nLaerd. 2015. Statistical Tutorials and Software Guides. https://statistics.laerd.com/.",
    "crumbs": [
      "<span class='chapter-number'>2</span>  <span class='chapter-title'>Kaplan-Meier</span>"
    ]
  },
  {
    "objectID": "02-km.html#footnotes",
    "href": "02-km.html#footnotes",
    "title": "2  Kaplan-Meier",
    "section": "",
    "text": "The delta method approximates the variance of a function of an estimator using a Taylor expansion.↩︎\nWith uninformative censoring, censoring causes are independent of the event. Subjects do not drop out of the study because of something related to their group. E.g., a subject does not drop out of a therapy study because the therapy is making their condition worse.↩︎\nUse gtsummary::inline_text() to summarize (e.g., gtsummary::inline_text(t1, variable = status, level = \"censored\", column = \"Asymptomatic\").↩︎\nSee neat discussion in Note section of Surv() help file.↩︎",
    "crumbs": [
      "<span class='chapter-number'>2</span>  <span class='chapter-title'>Kaplan-Meier</span>"
    ]
  },
  {
    "objectID": "index.html",
    "href": "index.html",
    "title": "Survival Analysis",
    "section": "",
    "text": "Preface\nThese notes are a personal reference related to my survival analysis work.\nRepo for this quarto book: https://github.com/mpfoley73/survival.",
    "crumbs": [
      "Preface"
    ]
  }
]